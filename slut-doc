#!/usr/bin/env node

'use strict';

var fs = require('fs');
var fileHelper = require('./file-helper');
var docBlocks = require('./doc-blocks');
var util = require('./util');

// ================================================

var docBlockRegex = /\/\*{2,}(.|[\r\n])+?\*\//g;
var blockDescRegex = /\/\*{2,}(.|[\r\n])+?(?=\* @)/g;

/**
* @param {String} filePath
* @return {String[]}
* @private
*/
var getRawBlocksFromFile = function (filePath) {
    var text = fs.readFileSync(filePath, 'utf-8');
    return findBlocks(text);
};


/**
* @function getBlocksFromFiles
* @param {String[]} filePaths
* @return {DocBlock[]}
* @private
*/
var getBlocksFromFiles = function (filePaths) {
    var i, max, result = [];

    var getBlocks = function (rawBlocks, filePath) {
        var blocks = [];

        util.each(rawBlocks, function (block, i) {
            blocks.push(
                new docBlocks.DocBlock(block, filePath)
            );
        });

        return blocks;
    };

    util.each(filePaths, function (filePath) {
        var rawBlocks = getRawBlocksFromFile(filePath);
        result = result.concat(getBlocks(rawBlocks, filePath));
    });

    return result;
};

/**
* Find blocks of documentation (doc block).
* @param {String} text
* @param {RegExp} [pattern = /\/\*{2,}.+\*\//g]
* @return {String[]}
* @private
*/
var findBlocks = function (text, pattern) {
    var blocks = [];
    pattern = pattern || docBlockRegex;

    blocks = text.match(pattern);

    return blocks || [];
};

/**
* @param {String} block
* @return {String}
*/
var getBlockDescription = function (block) {
    var desc = block.match(blockDescRegex);

    // remove all the junk before and after the description
    if (desc) {
        desc = desc[0].replace(/\/\*{2,}(.|[\r\n])+?(?=[a-z])/gi, '').trim();
    }

    return desc || '';
};

/**
* @param {DocBlock[]} blocks
* @return {String}
*/
var stringify = function (blocks) {
    var str = '';

    util.each(blocks, function (block) {
        str += block.stringify();
    });  

    return str;
};

/**
* @param {String} [directory = process.cwd()]
*/
var main = function (directory) {
    
    // find the files
    var files = fileHelper.getFiles(directory, null, true).files;

    // find the blocks in each
    var blocks = getBlocksFromFiles(files);

    var result = stringify(blocks);

    // console.log(result);

    fs.writeFileSync('api.md', result);
};

// ================================================

// main();

exports.main = main;

// TODO: These should not be public.  This is only for testing.
exports.findBlocks = findBlocks;
exports.getBlockDescription = getBlockDescription;